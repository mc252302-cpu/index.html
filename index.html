<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Leverage Trading Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #9ca3af;
            --up-color: #26a69a;
            --down-color: #ef5350;
            --accent-color: #fdd835;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header {
            background-color: var(--panel-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            height: 60px;
        }

        .dashboard-item { display: flex; flex-direction: column; min-width: 100px; }
        .label { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
        .value { font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .pnl.positive { color: var(--up-color); }
        .pnl.negative { color: var(--down-color); }
        
        .roe { font-size: 12px; margin-left: 5px; font-weight: normal; } /* ìˆ˜ìµë¥  í‘œì‹œ */

        /* ì°¨íŠ¸ ì˜ì—­ */
        #chart-wrapper {
            flex-grow: 1;
            position: relative;
            width: 100%;
        }
        #chart-container { width: 100%; height: 100%; }

        /* ê°€ê²© ì˜¤ë²„ë ˆì´ */
        .price-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            pointer-events: none;
        }
        .current-price-display {
            font-size: 36px;
            font-weight: 800;
            text-shadow: 0 2px 5px rgba(0,0,0,0.7);
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls {
            background-color: var(--panel-bg);
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid #333;
            height: 140px; /* ë†’ì´ ì¦ê°€ */
        }

        /* ë ˆë²„ë¦¬ì§€ ìŠ¬ë¼ì´ë” ì˜ì—­ */
        .leverage-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
        }
        .leverage-value {
            color: var(--accent-color);
            font-weight: bold;
            font-size: 18px;
            min-width: 60px;
            text-align: right;
        }
        input[type=range] {
            width: 70%;
            cursor: pointer;
        }

        /* ë²„íŠ¼ ì˜ì—­ */
        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            width: 100%;
        }

        button {
            border: none;
            border-radius: 6px;
            flex: 1;
            height: 50px;
            font-size: 16px;
            font-weight: 800;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        .btn-long { background: linear-gradient(135deg, #26a69a 0%, #00897b 100%); }
        .btn-short { background: linear-gradient(135deg, #ef5350 0%, #c62828 100%); }
        .btn-close { background-color: #546e7a; max-width: 120px; }

        /* í¬ì§€ì…˜ ì •ë³´ ë±ƒì§€ */
        #pos-info {
            display: none; 
            font-size: 12px; 
            background: rgba(255,255,255,0.1); 
            padding: 2px 6px; 
            border-radius: 4px;
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <header>
        <div class="dashboard-item">
            <span class="label">ë‚´ ìì‚° (Equity)</span>
            <span class="value" id="balance-display">$10,000.00</span>
        </div>
        <div class="dashboard-item" style="align-items: center;">
            <span class="label">í¬ì§€ì…˜</span>
            <div style="display:flex; align-items:center;">
                <span class="value" id="position-type">ëŒ€ê¸° ì¤‘</span>
                <span id="pos-info">10x</span>
            </div>
        </div>
        <div class="dashboard-item" style="text-align: right;">
            <span class="label">ë¯¸ì‹¤í˜„ ì†ìµ (PnL)</span>
            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <span class="value pnl" id="pnl-display">$0.00</span>
                <span class="roe pnl" id="roe-display">0.00%</span>
            </div>
        </div>
    </header>

    <div id="chart-wrapper">
        <div class="price-overlay">
            <div class="label" style="font-size:14px; margin-bottom:5px; font-weight:bold;">BTC/USDT Perpetual</div>
            <div id="live-price" class="current-price-display">Loading...</div>
        </div>
        <div id="chart-container"></div>
    </div>

    <div class="controls">
        <div class="leverage-control">
            <span class="label" style="font-size:14px; color:#fff;">ë°°ìœ¨ ì„¤ì • (Leverage)</span>
            <input type="range" id="leverage-slider" min="1" max="100" value="10" step="1" oninput="updateLeverageDisplay(this.value)">
            <span id="leverage-text" class="leverage-value">10x</span>
        </div>

        <div class="buttons">
            <button class="btn-long" id="btn-long" onclick="trade('long')">Long ğŸš€</button>
            <button class="btn-close" id="btn-close" onclick="closePosition()" disabled>Close</button>
            <button class="btn-short" id="btn-short" onclick="trade('short')">Short ğŸ“‰</button>
        </div>
    </div>

    <script>
        // --- 1. ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì²´í¬ ---
        window.onload = function() {
            if (typeof LightweightCharts === 'undefined') {
                alert("ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨! ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                return;
            }
            initGame();
        };

        // --- 2. ê²Œì„ ë³€ìˆ˜ ---
        let balance = 10000;
        let currentPrice = 60000; // ë¹„íŠ¸ì½”ì¸ ê°€ê²©ëŒ€
        let position = null;      // 'long' | 'short' | null
        let entryPrice = 0;
        let contractQty = 0;      // ë³´ìœ  ì½”ì¸ ê°œìˆ˜
        let currentLeverage = 10; // ê¸°ë³¸ ë ˆë²„ë¦¬ì§€
        let entryLeverage = 10;   // ì§„ì… ë‹¹ì‹œ ë ˆë²„ë¦¬ì§€

        let candleData = [];
        let markers = [];
        let chart, series;

        // UI ì—˜ë¦¬ë¨¼íŠ¸
        const elBalance = document.getElementById('balance-display');
        const elPnL = document.getElementById('pnl-display');
        const elRoe = document.getElementById('roe-display');
        const elLivePrice = document.getElementById('live-price');
        const elPosType = document.getElementById('position-type');
        const elPosInfo = document.getElementById('pos-info');
        const elLevText = document.getElementById('leverage-text');
        const elLevSlider = document.getElementById('leverage-slider');
        
        const btnLong = document.getElementById('btn-long');
        const btnShort = document.getElementById('btn-short');
        const btnClose = document.getElementById('btn-close');

        // --- 3. ê²Œì„ ì´ˆê¸°í™” ---
        function initGame() {
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#121212' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#2B2B43' }, horzLines: { color: '#2B2B43' } },
                timeScale: { timeVisible: true, secondsVisible: true, borderColor: '#485c7b' },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            });

            series = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350',
                borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });

            // ë°˜ì‘í˜• ì²˜ë¦¬
            new ResizeObserver(entries => {
                if(entries.length) chart.applyOptions({ width: entries[0].contentRect.width, height: entries[0].contentRect.height });
            }).observe(container);

            generateInitialData();
            startGameLoop();
        }

        // --- 4. ë°ì´í„° ìƒì„± ë° ë£¨í”„ ---
        function generateInitialData() {
            let time = Math.floor(Date.now() / 1000) - (200 * 60);
            let price = currentPrice;
            for (let i = 0; i < 200; i++) {
                let change = (Math.random() - 0.5) * 200; // ë³€ë™í­
                let open = price;
                let close = price + change;
                let high = Math.max(open, close) + Math.random() * 50;
                let low = Math.min(open, close) - Math.random() * 50;
                candleData.push({ time: time + (i * 60), open, high, low, close });
                price = close;
            }
            series.setData(candleData);
            currentPrice = price;
        }

        function startGameLoop() {
            let lastCandle = candleData[candleData.length - 1];
            let tickCount = 0;

            setInterval(() => {
                // ê°€ê²© ë³€ë™ (ëœë¤ ì›Œí¬ + ì•½ê°„ì˜ ì¶”ì„¸)
                const volatility = 30; // ë³€ë™ì„± ì¦ê°€
                const noise = (Math.random() - 0.5) * volatility;
                currentPrice += noise;

                // ìº”ë“¤ ì—…ë°ì´íŠ¸
                lastCandle.close = currentPrice;
                lastCandle.high = Math.max(lastCandle.high, currentPrice);
                lastCandle.low = Math.min(lastCandle.low, currentPrice);
                
                series.update(lastCandle);
                updateUI(lastCandle.open);
                checkLiquidation(); // ì²­ì‚° ì²´í¬

                tickCount++;
                if (tickCount > 10) { // ìƒˆ ìº”ë“¤ ìƒì„± ì£¼ê¸° (ë¹ ë¥´ê²Œ)
                    tickCount = 0;
                    const nextTime = lastCandle.time + 60;
                    lastCandle = { time: nextTime, open: currentPrice, high: currentPrice, low: currentPrice, close: currentPrice };
                }
            }, 100);
        }

        // --- 5. UI ë° ê³„ì‚° ë¡œì§ ---
        function updateLeverageDisplay(val) {
            currentLeverage = parseInt(val);
            elLevText.innerText = currentLeverage + 'x';
            if(position !== null) {
                // í¬ì§€ì…˜ ì¡ê³  ìˆì„ ë• ìŠ¬ë¼ì´ë” ë³€ê²½í•´ë„ ì ìš© ì•ˆ ë¨ì„ ì‹œê°ì ìœ¼ë¡œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            }
        }

        function updateUI(openPrice) {
            // ê°€ê²© ìƒ‰ìƒ
            elLivePrice.innerText = currentPrice.toLocaleString(undefined, {minimumFractionDigits:2});
            elLivePrice.style.color = currentPrice >= openPrice ? 'var(--up-color)' : 'var(--down-color)';

            if (position) {
                // PnL ê³„ì‚°: (í˜„ì¬ê°€ - ì§„ì…ê°€) * ìˆ˜ëŸ‰
                let rawPnl = 0;
                if (position === 'long') {
                    rawPnl = (currentPrice - entryPrice) * contractQty;
                } else {
                    rawPnl = (entryPrice - currentPrice) * contractQty;
                }

                // ìˆ˜ìµë¥  ê³„ì‚°: PnL / ë‚´ ì›ê¸ˆ(ì¦ê±°ê¸ˆ) * 100
                // ì—¬ê¸°ì„œ 'ë‚´ ì›ê¸ˆ'ì€ ì§„ì… ë‹¹ì‹œ ì‚¬ìš©í•œ balance ì „ì²´ë¼ê³  ê°€ì • (All-in ëª¨ë“œ)
                // ì‹¤ì œ ê±°ë˜ì†Œ: ROE = (Unrealized PnL / Initial Margin) * 100
                // ê°„í¸ ê³„ì‚°: ê°€ê²©ë³€ë™ë¥  * ë ˆë²„ë¦¬ì§€
                let priceDiffPct = (rawPnl / (entryPrice * contractQty)); // ì´ í¬ì§€ì…˜ ê°€ì¹˜ ëŒ€ë¹„ ë³€ë™í­ (ë ˆë²„ë¦¬ì§€ ë¯¸ë°˜ì˜)
                // í•˜ì§€ë§Œ contractQty ìì²´ê°€ ë ˆë²„ë¦¬ì§€ë¥¼ í¬í•¨í•´ ê³„ì‚°ë˜ì—ˆìœ¼ë¯€ë¡œ,
                // ROE = rawPnl / (Entry Balance) * 100
                
                // ì§„ì… ì‹œ ì‚¬ìš©ëœ ì¦ê±°ê¸ˆ = (entryPrice * contractQty) / entryLeverage
                let usedMargin = (entryPrice * contractQty) / entryLeverage;
                let roe = (rawPnl / usedMargin) * 100;

                elPnL.innerText = `${rawPnl >= 0 ? '+' : ''}$${rawPnl.toLocaleString(undefined, {minimumFractionDigits:2})}`;
                elRoe.innerText = `${roe >= 0 ? '+' : ''}${roe.toFixed(2)}%`;
                
                let colorClass = rawPnl >= 0 ? 'positive' : 'negative';
                elPnL.className = `value pnl ${colorClass}`;
                elRoe.className = `roe pnl ${colorClass}`;
            }
        }

        // ì²­ì‚°(Liquidation) ë¡œì§
        function checkLiquidation() {
            if (!position) return;

            let rawPnl = 0;
            if (position === 'long') rawPnl = (currentPrice - entryPrice) * contractQty;
            else rawPnl = (entryPrice - currentPrice) * contractQty;

            // í‰ê°€ ë‹´ë³´ê¸ˆ = ì´ˆê¸° ìë³¸ + ì†ìµ
            // ë§Œì•½ ì†ì‹¤ì´ ì´ˆê¸° ìë³¸ê¸ˆì„ ë‹¤ ê¹Œë¨¹ìœ¼ë©´ ì²­ì‚°
            // ì‹¤ì œë¡œëŠ” ìœ ì§€ì¦ê±°ê¸ˆì´ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  0ì› ë˜ë©´ ì²­ì‚°ìœ¼ë¡œ ë‹¨ìˆœí™”
            if (balance + rawPnl <= 0) {
                liquidatePosition();
            }
        }

        function liquidatePosition() {
            // ê°•ì œ ì²­ì‚°
            addMarker('Liquidation', 0);
            alert(`ğŸ’¥ ê°•ì œ ì²­ì‚° ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¥\n\nëª¨ë“  ìì‚°ì´ ì†Œë©¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ê²Œì„ì´ ë¦¬ì…‹ë©ë‹ˆë‹¤)`);
            
            // ë¦¬ì…‹
            balance = 10000;
            position = null;
            entryPrice = 0;
            contractQty = 0;
            
            updateBalanceDisplay();
            resetControls();
        }

        // --- 6. íŠ¸ë ˆì´ë”© í•¨ìˆ˜ ---
        window.trade = function(type) {
            if (position !== null) return;

            // ì§„ì… ì„¤ì •
            position = type;
            entryPrice = currentPrice;
            entryLeverage = currentLeverage;
            
            // ìˆ˜ëŸ‰ ê³„ì‚° (ì „ì¬ì‚° í’€ë§¤ìˆ˜ ê¸°ì¤€)
            // ì´ í¬ì§€ì…˜ ê·œëª¨ = ë‚´ëˆ * ë ˆë²„ë¦¬ì§€
            let totalPositionValue = balance * entryLeverage;
            contractQty = totalPositionValue / entryPrice;

            // UI ì—…ë°ì´íŠ¸
            elLevSlider.disabled = true; // ì§„ì… ì¤‘ ë°°ìœ¨ ë³€ê²½ ë¶ˆê°€
            btnLong.disabled = true;
            btnShort.disabled = true;
            btnClose.disabled = false;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë”¤ì²˜ë¦¬
            btnLong.style.opacity = 0.3;
            btnShort.style.opacity = 0.3;
            btnClose.style.opacity = 1;

            elPosType.innerText = type.toUpperCase();
            elPosType.style.color = type === 'long' ? 'var(--up-color)' : 'var(--down-color)';
            elPosInfo.style.display = 'inline-block';
            elPosInfo.innerText = `${entryLeverage}x`;
            elPosInfo.style.color = type === 'long' ? '#80cbc4' : '#ef9a9a'; // ì—°í•œ ìƒ‰

            addMarker(type === 'long' ? 'Buy' : 'Sell');
        };

        window.closePosition = function() {
            if (!position) return;

            // ìµœì¢… ì†ìµ ê³„ì‚°
            let rawPnl = 0;
            if (position === 'long') rawPnl = (currentPrice - entryPrice) * contractQty;
            else rawPnl = (entryPrice - currentPrice) * contractQty;

            balance += rawPnl;
            addMarker('Close', rawPnl);

            // ì´ˆê¸°í™”
            position = null;
            contractQty = 0;
            entryPrice = 0;
            
            elPnL.innerText = "$0.00";
            elRoe.innerText = "0.00%";
            elPnL.className = "value pnl";

            updateBalanceDisplay();
            resetControls();
        };

        function resetControls() {
            elLevSlider.disabled = false;
            btnLong.disabled = false;
            btnShort.disabled = false;
            btnClose.disabled = true;
            
            btnLong.style.opacity = 1;
            btnShort.style.opacity = 1;
            btnClose.style.opacity = 0.3;

            elPosType.innerText = "ëŒ€ê¸° ì¤‘";
            elPosType.style.color = "#e0e0e0";
            elPosInfo.style.display = 'none';
        }

        function updateBalanceDisplay() {
            elBalance.innerText = `$${balance.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
        }

        // ì°¨íŠ¸ ë§ˆì»¤
        function addMarker(action, pnl) {
            let color, shape, text, pos;
            let time = series.dataByIndex(series.data().length - 1).time;

            if (action === 'Buy') {
                color = '#26a69a'; shape = 'arrowUp'; text = `LONG ${entryLeverage}x`; pos = 'belowBar';
            } else if (action === 'Sell') {
                color = '#ef5350'; shape = 'arrowDown'; text = `SHORT ${entryLeverage}x`; pos = 'aboveBar';
            } else if (action === 'Liquidation') {
                color = '#d32f2f'; shape = 'circle'; text = 'ğŸ’¥ LIQUIDATED'; pos = 'aboveBar';
            } else {
                color = pnl >= 0 ? '#fdd835' : '#b0bec5';
                shape = 'circle'; 
                text = `Close ${pnl>=0?'+':''}$${Math.floor(pnl)}`; 
                pos = position === 'long' ? 'aboveBar' : 'belowBar';
            }

            markers.push({ time, position: pos, color, shape, text });
            markers.sort((a,b)=>a.time - b.time);
            series.setMarkers(markers);
        }
    </script>
</body>
</html>
